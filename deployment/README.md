# 图片生成任务优化部署指南

## 问题解决

此优化方案解决以下问题：

1. 网络连接中断导致前端报错但后端任务仍在进行
2. 本地存储配额溢出导致任务恢复失败
3. 任务恢复机制不完善，临时任务ID无法关联到真实任务
4. 任务通知机制失败导致前端无法获取任务状态

## 部署步骤

### 1. 服务器超时配置调整

#### Nginx配置

查看 `tmp/nginx.conf` 文件，关键修改：

- 增加 `/api/generate-image*` 路径的超时时间到5分钟
- 增加 `/api/image-task-status` 路径的超时时间到3分钟
- 增加 `/api/task-final-check` 路径的超时时间到3分钟

请根据实际部署环境修改Nginx配置，然后重新加载：

```bash
sudo nginx -t  # 验证配置
sudo systemctl reload nginx  # 重新加载配置
```

### 2. 新增API端点

以下API端点必须正确部署：

- `/app/api/last-task-for-user` - 获取用户最近任务
- `/app/api/task-final-check/[taskId]` - 任务最终状态检查

### 3. 代码修改

主要修改内容：

1. 减小本地存储数据量
   - 修改了任务存储机制，不再存储完整图片数据
   - 添加存储配额超出处理

2. 增强任务恢复机制
   - 添加多级任务查询策略
   - 支持临时任务ID映射到真实任务ID

3. 增强网络故障处理
   - 添加网络断开检测和自动重连
   - 增加网络状态监听和超时处理

4. 优化任务状态轮询
   - 添加备用轮询策略
   - 优化超时和错误处理

## 测试验证

部署后，请验证以下场景：

1. 正常图片生成流程
2. 网络中断后的恢复能力
3. 上传大图片生成时的本地存储问题
4. 临时任务与真实任务的映射

## 注意事项

- 前端超时时间增加到5分钟，后端任务处理超时为6分钟
- 即使前端报错，后端任务仍会继续处理
- 本地存储不再保存完整图片数据，仅记录基本任务信息
